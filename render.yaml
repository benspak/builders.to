# Render.com Blueprint
# https://render.com/docs/blueprint-spec

services:
  # Next.js Web Service
  - type: web
    name: builders-to
    runtime: node
    region: oregon # or: ohio, frankfurt, singapore
    plan: standard # free, starter, standard, pro
    buildCommand: chmod +x ./scripts/render-build.sh && ./scripts/render-build.sh
    startCommand: chmod +x ./scripts/render-start.sh && ./scripts/render-start.sh
    healthCheckPath: /
    # Persistent disk for user uploads
    disk:
      name: uploads
      mountPath: /var/data/uploads
      sizeGB: 1
    envVars:
      - key: NODE_ENV
        value: production
      - key: AUTH_TRUST_HOST
        value: "true"
      - key: UPLOAD_DIR
        value: /var/data/uploads
      - key: DATABASE_URL
        fromDatabase:
          name: builders-to-db
          property: connectionString
      - key: NEXTAUTH_URL
        sync: false # Set this manually after deployment
      - key: NEXTAUTH_SECRET
        generateValue: true
      - key: TWITTER_CLIENT_ID
        sync: false
      - key: TWITTER_CLIENT_SECRET
        sync: false
      - key: CRON_SECRET
        sync: false
      # Pro Subscription - Stripe price IDs and webhook secret
      - key: STRIPE_PRO_MONTHLY_PRICE_ID
        sync: false
      - key: STRIPE_PRO_YEARLY_PRICE_ID
        sync: false
      - key: STRIPE_PRO_WEBHOOK_SECRET
        sync: false

  # ============================================
  # Cron Jobs
  # ============================================

  # Daily digest emails - sends summary of likes/upvotes to users
  - type: cron
    name: builders-to-daily-digest
    runtime: node
    region: oregon
    schedule: "0 18 * * *"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs daily-digest
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

  # Accountability reminders - nudges users to post their daily update
  - type: cron
    name: builders-to-accountability-reminders
    runtime: node
    region: oregon
    schedule: "0 14 * * *"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs accountability-reminders
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

  # Expire ads - marks expired advertisements
  - type: cron
    name: builders-to-expire-ads
    runtime: node
    region: oregon
    schedule: "0 1 * * *"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs expire-ads
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

  # Expire services - marks expired service listings
  - type: cron
    name: builders-to-expire-services
    runtime: node
    region: oregon
    schedule: "15 1 * * *"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs expire-services
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

  # Expire local listings - marks expired local listings
  - type: cron
    name: builders-to-expire-local-listings
    runtime: node
    region: oregon
    schedule: "30 1 * * *"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs expire-local-listings
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

  # Data cleanup - removes old notifications, sessions, and analytics data
  - type: cron
    name: builders-to-cleanup
    runtime: node
    region: oregon
    schedule: "0 3 * * 6"
    buildCommand: npm install
    startCommand: node scripts/run-cron.mjs cleanup
    envVars:
      - key: CRON_SECRET
        sync: false
      - key: NEXTAUTH_URL
        sync: false

databases:
  # PostgreSQL Database
  - name: builders-to-db
    region: oregon # Should match web service region
    plan: Basic-256mb # free, starter, standard, pro
    databaseName: builders_to
    user: builders_to_user
    ipAllowList: [] # Allow all IPs (Render services connect internally)
